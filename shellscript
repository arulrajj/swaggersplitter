#!/bin/bash

# ========================================
#    BT Bill Comparison Tool
#    Unix/Linux Version
# ========================================

set -e  # Exit on any error

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Set paths
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
INPUT_OLD="${SCRIPT_DIR}/input/old_bills"
INPUT_NEW="${SCRIPT_DIR}/input/new_bills"
OUTPUT_DIR="${SCRIPT_DIR}/output"
LOG_FILE="${SCRIPT_DIR}/comparison.log"

echo -e "${BLUE}========================================${NC}"
echo -e "${BLUE}   BT Bill Comparison Tool${NC}"
echo -e "${BLUE}   Unix/Linux Version${NC}"
echo -e "${BLUE}========================================${NC}"
echo

# Create directories if they don't exist
mkdir -p "$INPUT_OLD" "$INPUT_NEW" "$OUTPUT_DIR"

echo -e "${YELLOW}Checking Python installation...${NC}"
if ! command -v python3 &> /dev/null; then
    echo -e "${RED}ERROR: Python 3 is not installed or not in PATH${NC}"
    echo "Please install Python 3.7+ using your package manager:"
    echo "  Ubuntu/Debian: sudo apt install python3 python3-pip"
    echo "  CentOS/RHEL: sudo yum install python3 python3-pip"
    echo "  macOS: brew install python3"
    exit 1
fi

PYTHON_VERSION=$(python3 --version 2>&1)
echo -e "${GREEN}Found: $PYTHON_VERSION${NC}"

echo
echo -e "${YELLOW}Checking dependencies...${NC}"
if ! python3 -c "import pkg_resources; pkg_resources.require(open('requirements.txt', mode='r'))" &> /dev/null; then
    echo "Installing missing dependencies..."
    pip3 install -r requirements.txt
    if [ $? -ne 0 ]; then
        echo -e "${RED}ERROR: Failed to install dependencies${NC}"
        echo "Please check requirements.txt and internet connection"
        exit 1
    fi
    echo -e "${GREEN}Dependencies installed successfully${NC}"
else
    echo -e "${GREEN}All dependencies are already installed${NC}"
fi

echo
echo -e "${YELLOW}Checking system dependencies...${NC}"
# Check for PDF processing dependencies
if ! command -v tesseract &> /dev/null; then
    echo -e "${YELLOW}Warning: tesseract-ocr not found. OCR fallback will not work.${NC}"
    echo "To install:"
    echo "  Ubuntu/Debian: sudo apt install tesseract-ocr poppler-utils"
    echo "  CentOS/RHEL: sudo yum install tesseract poppler-utils"
    echo "  macOS: brew install tesseract poppler"
fi

echo
echo -e "${BLUE}Input directories:${NC}"
echo -e " - Old bills: $INPUT_OLD"
echo -e " - New bills: $INPUT_NEW"
echo
echo -e "${BLUE}Output directory:${NC} $OUTPUT_DIR"
echo

# Count PDF files
OLD_COUNT=$(find "$INPUT_OLD" -name "*.pdf" -type f | wc -l)
NEW_COUNT=$(find "$INPUT_NEW" -name "*.pdf" -type f | wc -l)

echo -e "Found ${GREEN}$OLD_COUNT${NC} PDFs in old_bills folder"
echo -e "Found ${GREEN}$NEW_COUNT${NC} PDFs in new_bills folder"
echo

if [ "$OLD_COUNT" -eq 0 ]; then
    echo -e "${YELLOW}WARNING: No PDF files found in old_bills folder${NC}"
    echo "Please place your original bills in: $INPUT_OLD"
    echo
fi

if [ "$NEW_COUNT" -eq 0 ]; then
    echo -e "${YELLOW}WARNING: No PDF files found in new_bills folder${NC}"
    echo "Please place your new bills in: $INPUT_NEW"
    echo
fi

if [ "$OLD_COUNT" -eq 0 ] && [ "$NEW_COUNT" -eq 0 ]; then
    echo -e "${RED}No PDF files found. Exiting.${NC}"
    exit 1
fi

echo -e "${YELLOW}Starting bill comparison...${NC}"
echo -e "Log file: $LOG_FILE"
echo

# Run the comparison
python3 bt_comparator.py --dirA "$INPUT_OLD" --dirB "$INPUT_NEW" --out "$OUTPUT_DIR" --log "$LOG_FILE"

if [ $? -eq 0 ]; then
    echo
    echo -e "${GREEN}========================================${NC}"
    echo -e "${GREEN}   COMPARISON COMPLETED SUCCESSFULLY${NC}"
    echo -e "${GREEN}========================================${NC}"
    echo
    
    # Count generated reports
    REPORT_COUNT=$(find "$OUTPUT_DIR" -name "*.json" -o -name "*.html" | wc -l)
    echo -e "Generated ${GREEN}$REPORT_COUNT${NC} report files"
    echo
    echo -e "Reports are in: ${BLUE}$OUTPUT_DIR${NC}"
    echo
    
    # Try to open file manager (if GUI available)
    if command -v xdg-open &> /dev/null; then
        echo "Opening output directory..."
        xdg-open "$OUTPUT_DIR" &
    elif command -v open &> /dev/null; then
        echo "Opening output directory..."
        open "$OUTPUT_DIR" &
    fi
    
else
    echo
    echo -e "${RED}ERROR: Comparison failed. Check log file: $LOG_FILE${NC}"
    exit 1
fi
