#!/usr/bin/env python3

import pdfplumber
import re
import sys
import html
from jinja2 import Template
import pandas as pd

# Regex to detect money values
AMOUNT_RE = re.compile(r"[-]?\£?\s*[\d,]+(?:\.\d{1,2})?")
# Regex to detect date formats in BT bills (e.g., 2 Apr 25)
DATE_RE = re.compile(r"\d{1,2}\s+[A-Za-z]{3}\s+\d{2}")

KEY_PATTERNS = {
    "regular_charges": ["regular charges"],
    "one_off_charges": ["one-off charges", "one off charges", "one-off charges and credits", "one off charges and credits"],
    "discounts": ["discounts"],
    "total_vat": ["total vat", "vat at 20%", "vat at 20"],
    "total_for_bill": ["total for this bill", "total which includes total vat"],
}

def extract_text(pdf_path):
    with pdfplumber.open(pdf_path) as pdf:
        text = "\n".join([page.extract_text() or "" for page in pdf.pages])
    return text.replace("\xa0", " ").strip()

def find_amount(line):
    m = AMOUNT_RE.search(line)
    return m.group(0) if m else None

def parse_amount(raw):
    if not raw: return None
    s = raw.replace("£","").replace(",","").strip()
    try:
        return float(s)
    except:
        return None

def extract_summary_fields(text):
    lines = [l.strip() for l in text.splitlines() if l.strip()]
    lower = [l.lower() for l in lines]
    result = {k: None for k in KEY_PATTERNS}

    for key, patterns in KEY_PATTERNS.items():
        for i,l in enumerate(lower):
            if any(p in l for p in patterns):
                amt = find_amount(lines[i])
                if amt:
                    result[key] = parse_amount(amt)
                    break
                for j in range(i, min(i+4, len(lines))):
                    amt = find_amount(lines[j])
                    if amt:
                        result[key] = parse_amount(amt)
                        break
                break
    return result

def extract_line_items(text):
    items = []
    for line in text.splitlines():
        line = line.strip()
        if not DATE_RE.search(line):
            continue
        amt = find_amount(line)
        if not amt:
            continue
        
        parts = line.split()
        date = " ".join(parts[:3])   # ex: 2 Apr 25
        description = " ".join(parts[3:-1])
        amount = parse_amount(amt)
        key = description.lower().replace(" ", "_")

        items.append(dict(
            date=date,
            description=description,
            key=key,
            amount=amount
        ))
    return pd.DataFrame(items)

def compare_summaries(s1, s2):
    rows = []
    for k in sorted(set(s1.keys()) | set(s2.keys())):
        v1, v2 = s1.get(k), s2.get(k)
        diff = None
        if v1 is not None and v2 is not None:
            diff = round(v2 - v1, 2)
        rows.append((k, v1, v2, diff))
    return rows

def compare_line_items(df1, df2):
    merged = pd.merge(df1, df2, on="key", how="outer", suffixes=("_left", "_right"))
    merged["difference"] = merged["amount_right"] - merged["amount_left"]
    return merged

HTML_TEMPLATE = """
<!doctype html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Bill Comparison</title>
  <style>
    body { font-family: Arial; margin: 20px; }
    table { border-collapse: collapse; width: 100%; margin-bottom: 25px; }
    th, td { border: 1px solid #ccc; padding: 8px; }
    th { background: #f2f2f2; }
    .changed { background: #ffecec; }
  </style>
</head>
<body>

<h1>Telecom Bill Comparison</h1>

<h2>Summary Fields</h2>
<table>
<tr><th>Field</th><th>Old</th><th>New</th><th>Difference</th></tr>
{% for k, v1, v2, diff in summary %}
<tr class="{{ 'changed' if diff and diff != 0 else '' }}">
<td>{{ k }}</td>
<td>{{ v1 }}</td>
<td>{{ v2 }}</td>
<td>{{ diff }}</td>
</tr>
{% endfor %}
</table>

<h2>Line Item Comparison</h2>
<table>
<tr><th>Description</th><th>Old</th><th>New</th><th>Difference</th></tr>
{% for row in items %}
<tr class="{{ 'changed' if row.difference and row.difference != 0 else '' }}">
<td>{{ row.description }}</td>
<td>{{ row.amount_left }}</td>
<td>{{ row.amount_right }}</td>
<td>{{ row.difference }}</td>
</tr>
{% endfor %}
</table>

</body></html>
"""

def main():
    old, new = sys.argv[1], sys.argv[2]
    
    t1, t2 = extract_text(old), extract_text(new)
    s1, s2 = extract_summary_fields(t1), extract_summary_fields(t2)

    summary_rows = compare_summaries(s1, s2)
    df1, df2 = extract_line_items(t1), extract_line_items(t2)
    items = compare_line_items(df1, df2).to_dict("records")

    html_out = Template(HTML_TEMPLATE).render(summary=summary_rows, items=items)
    with open("bill_comparison_report.html","w",encoding="utf-8") as f:
        f.write(html_out)

    print("✅ Comparison done → bill_comparison_report.html")

if __name__ == "__main__":
    main()
